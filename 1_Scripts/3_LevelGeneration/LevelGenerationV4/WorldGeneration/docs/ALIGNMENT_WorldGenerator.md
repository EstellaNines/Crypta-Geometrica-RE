# 世界生成器 V4 - 需求对齐文档

> **任务名称**: WorldGenerator  
> **创建日期**: 2026-01-19  
> **阶段**: Phase 1 - Align

---

## 📋 原始需求

### 用户需求摘要

设计一个**新架构的世界生成器**，采用与房间生成器V4相同的网格架构风格，实现多房间的宏观布局管理。

### 核心概念定义

| 概念 | 定义 |
|------|------|
| **房间单位** | 房间生成器V4生成的单个房间，尺寸64×64像素，内部含4×4模块化网格 |
| **世界生成器** | 顶层网格生成器，通过随机数机制决定每个网格是否生成房间单位 |
| **世界单位** | 世界生成器的完整输出结构，场景内一般只允许一个 |
| **无多余房间定义** | 不需要Boss房、宝藏房等特殊房间类型，房间生成器V4已完成所有设定 |

### 参数设定

| 参数 | 规则 |
|------|------|
| **网格尺寸** | X×X，其中X=设定房间数量（如6个房间→6×6网格） |
| **随机生成** | 每格独立随机数计算，超过阈值Y才生成，直到达到上限X |
| **房间间隔** | 房间与房间之间至少间隔一个房间单位距离 |

---

## 🔍 系统理解

### 现有房间生成器V4架构

```
DungeonGenerator (房间控制器)
    ├── DungeonPipelineData (SO配置)
    │   └── Rules[] (Macro/Micro/Border/Render)
    ├── DungeonContext (黑板模式)
    │   ├── RoomNodes[]
    │   ├── TileData[]
    │   └── 配置参数
    └── 异步执行管线 (UniTask)
```

**关键特性**:
- 4×4内部网格，64×64像素总尺寸
- 规则管线顺序执行
- 黑板模式共享数据
- 支持取消/重试机制

### 世界生成器与房间生成器关系

```
WorldGenerator (新增)
    ├── 世界网格布局 (X×X)
    │   └── 每格对应一个潜在房间位置
    ├── 随机放置算法
    │   └── 阈值判断 + 间隔约束
    └── 调用 DungeonGenerator[] 批量生成
         └── 每个WorldNode → 一个DungeonGenerator实例/调用
```

---

## ❓ 关键问题识别

### 问题1: 房间连通性

**问题**: 随机放置可能导致房间孤立（无法到达）  
**建议方案**: 添加后处理连通性验证，确保BFS可达性

### 问题2: 世界坐标转换

**问题**: 多房间渲染时需要正确的世界坐标偏移  
**已有支持**: `DungeonContext.WorldOffset` 已存在，可复用

### 问题3: 间隔约束实现

**问题**: "间隔一个房间单位距离" 的精确定义  
**解释**: 曼哈顿距离 ≥ 2（不允许相邻，包括对角线?）

### 问题4: 生成顺序

**问题**: 是否需要异步批量/并行生成多个房间?  
**建议**: 串行生成更稳定，但可预留并行扩展接口

---

## 🎯 边界定义

### 范围内 (In Scope)

- [x] 世界网格数据结构 (WorldNode, WorldContext)
- [x] 随机放置算法 (阈值+间隔约束)
- [x] 房间生成调度 (调用DungeonGenerator)
- [x] 坐标转换工具
- [x] 基础连通性保障

### 范围外 (Out of Scope)

- [ ] 特殊房间类型 (Boss/宝藏等)
- [ ] 复杂路径算法 (贝塞尔脊柱等)
- [ ] 门约束注入 (暂不实现房间间连接)
- [ ] 导航网格生成

---

## 📞 待确认事项 - 已确认

| 问题 | 用户回应 |
|------|----------|
| **连通性** | 暂不实现，后续走廊单位负责连通 |
| **世界坐标偏移** | 房间生成器已有转换，世界生成器新增WorldCoordinateConverter |
| **间隔定义** | **允许对角线相邻**，仅禁止正交相邻 |
| **生成模式** | 异步串行生成，加载期间完成全部房间 |
| **入口/出口** | 暂不需要，后续根据完成情况决定 |

---

> **状态**: 已确认，进入任务分解阶段
