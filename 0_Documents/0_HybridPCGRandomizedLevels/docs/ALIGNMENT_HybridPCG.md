# ALIGNMENT - 混合式程序化随机关卡系统 (Hybrid PCG)

## 一、项目上下文分析

### 1.1 项目基本信息
- **项目名称**: CRYPTA GEOMETRICA RE
- **项目类型**: 二维几何风格Roguelite游戏
- **开发引擎**: Unity (C#)
- **目标平台**: PC / 移动端

### 1.2 现有技术栈
- Unity Tilemap系统 (已有瓦片资源)
- 2D物理系统 (Rigidbody2D, Collider2D)
- 现有关卡预制件
- 现有敌人系统

### 1.3 项目架构模式
- 基于MonoBehaviour的组件架构
- ScriptableObject配置系统
- 对象池管理

---

## 二、原始需求

### 2.1 核心需求
实现一套**混合式程序化随机关卡生成系统**，融合:
1. **Spelunky式** - 确定性骨架，保证关卡可通关性
2. **Dead Cells式** - 有机血肉，打破网格刚性视觉

### 2.2 关键约束
1. **拓扑可解性**: 必须存在从起点到终点的可行路径
2. **物理可达性**: 路径必须通过玩家跳跃参数验证
3. **性能要求**: 运行时毫秒级生成，60FPS流畅运行

---

## 三、边界确认

### 3.1 任务范围内
- [x] 宏观网格生成系统 (4×4最大尺寸)
- [x] 不规则形状支持 (位掩码定义)
- [x] 关键路径算法 (醉汉行走变体)
- [x] 软边界活跃区域系统
- [x] WFC房间内部填充
- [x] Voronoi弹性走廊
- [x] Boss房间支持
- [x] 难度系统 (影响敌人数量)
- [x] Tilemap批处理渲染
- [x] 物理可达性验证 (Job+Burst)
- [x] 对象池管理

### 3.2 任务范围外
- [ ] 新的Tilemap瓦片资源制作 (使用现有资源)
- [ ] SDF Shader开发 (使用现有视觉方案)
- [ ] 敌人AI系统 (假设已存在)
- [ ] 存档/读档系统 (仅提供种子序列化接口)

---

## 四、需求理解

### 4.1 三层嵌套架构
```
┌─────────────────────────────────────────────┐
│ 宏观层 (Macro)                              │
│ - 4×4网格矩阵 (支持不规则形状)              │
│ - 关键路径生成 (Start → Boss → Exit)        │
│ - 房间类型: Start/Exit/LR/Drop/Landing/     │
│            Side/Shop/Abyss/Boss             │
├─────────────────────────────────────────────┤
│ 中观层 (Meso)                               │
│ - 软边界活跃区域 (70%缩放 + 随机偏移)       │
│ - WFC波函数坍缩填充                         │
│ - 敌人生成点布置                            │
├─────────────────────────────────────────────┤
│ 微观层 (Micro)                              │
│ - Voronoi控制点走廊                         │
│ - A*寻路 + 形态学平滑                       │
│ - Tilemap批处理渲染                         │
└─────────────────────────────────────────────┘
```

### 4.2 不规则形状支持
- 使用4×4位掩码矩阵定义关卡形状
- 示例: `0010,1111,0111,0000`
- 必须通过BFS连通性验证

### 4.3 难度递进系统
- 基础难度: 0.2
- 每关增量: +0.1
- 最大难度: 1.0
- 敌人数量 = 基础2个 + 难度加成

### 4.4 Boss房间规则
- 位于Exit房间前一格
- 活跃区域扩大1.3倍
- 固定最高难度1.0
- 敌人数量固定1个(Boss)

---

## 五、疑问澄清

### 5.1 已确认问题
| 问题 | 答案 | 来源 |
|------|------|------|
| 网格最大尺寸 | 4×4 | 用户确认 |
| 是否支持不规则形状 | 是，使用位掩码 | 用户确认 |
| 是否需要Boss房间 | 是 | 用户确认 |
| 视觉资源来源 | 使用现有Tilemap | 用户确认 |
| 难度系统 | 影响敌人数量，关卡递增 | 用户确认 |

### 5.2 基于工程实践的决策
| 问题 | 决策 | 依据 |
|------|------|------|
| WFC回溯策略 | 最大迭代500次后局部重置 | 行业标准实践 |
| 走廊宽度 | 4-6格 | 玩家角色尺寸考量 |
| 深渊判定 | 连续3+垂直Side房间 | 原始技术文档 |
| 物理验证并行度 | 64 batch size | Job System最佳实践 |

---

## 六、技术风险识别

### 6.1 高风险项
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| WFC死锁 | 生成失败 | 迭代上限+局部重置 |
| 关键路径断裂 | 不可通关 | 物理验证+补救模块 |

### 6.2 中风险项
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Tilemap性能 | 卡顿 | SetTilesBlock批处理 |
| GC峰值 | 掉帧 | 对象池+Native容器 |

### 6.3 低风险项
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Voronoi边缘尖锐 | 视觉瑕疵 | 元胞自动机平滑 |

---

## 七、文档状态

- **创建时间**: 2026-01-15
- **状态**: 已完成
- **下一步**: 创建CONSENSUS共识文档
