# 混合式程序化随机关卡系统 (Hybrid PCG) - 说明文档

## 一、项目规划

### 1.1 项目概述
为CRYPTA GEOMETRICA RE项目实现混合式程序化关卡生成系统，融合Spelunky确定性骨架和Dead Cells有机血肉设计理念。

### 1.2 核心目标
- 运行时毫秒级生成 (<100ms)
- 100%关卡可通关性
- 60FPS流畅运行
- 支持不规则关卡形状

### 1.3 技术栈
- Unity Tilemap + SetTilesBlock批处理
- C# Job System + Burst Compiler
- WFC波函数坍缩算法
- Voronoi + A*走廊生成

---

## 二、实施方案

### 2.1 三层架构
```
宏观层 → 中观层 → 微观层
(骨架)   (血肉)   (表皮)
```

### 2.2 开发阶段
| 阶段 | 内容 | 预计时间 |
|------|------|----------|
| Phase 1 | 数据结构定义 | 2小时 |
| **Phase 1.5** | **灰盒原型验证** | **3小时** |
| Phase 2 | 宏观层生成 | 3.5小时 |
| Phase 3 | 中观层生成 | 4小时 |
| Phase 4 | 微观层生成 | 3小时 |
| Phase 5 | 验证系统 | 3小时 |
| Phase 6 | 渲染层 | 1.5小时 |
| Phase 7 | 整合测试 | 3小时 |
| **总计** | **36个任务** | **23小时** |

> **灰盒阶段说明**: 使用红、蓝、绿、黄四色简单瓦片搭建视觉原型，
> 先验证单个房间模板效果，再汇总4×4网格预览，用户确认后继续后续开发。

---

## 三、进度记录

### 3.1 文档阶段 ✅
| 时间 | 完成内容 | 状态 |
|------|----------|------|
| 2026-01-15 | ALIGNMENT_HybridPCG.md | ✅ 完成 |
| 2026-01-15 | CONSENSUS_HybridPCG.md | ✅ 完成 |
| 2026-01-15 | DESIGN_HybridPCG.md | ✅ 完成 |
| 2026-01-15 | TASK_HybridPCG.md | ✅ 完成 |

### 3.2 开发阶段 ⏳ 进行中
| 任务ID | 任务名称 | 状态 |
|--------|----------|------|
| 1.1 | RoomType枚举 | ✅ |
| 1.2 | RoomNode类 | ✅ |
| 1.3 | LevelShape类 | ✅ |
| 1.4 | DifficultyConfig | ✅ |
| 1.5 | GenerationSettings | ✅ |
| 1.5.1 | 四色调试瓦片 | ✅ (用户完成) |
| 1.5.2 | 单房间模板测试场景 | ✅ |
| 1.5.3 | 9种房间类型模板 | ✅ |
| 1.5.4 | 房间模板预览工具 | ✅ |
| 1.5.5 | 4x4网格汇总预览 | ✅ |
| 1.5.6 | 灰盒效果验证 | ⏳ 等待用户确认 |

---

## 四、文件目录

```
0_Documents/0_HybridPCGRandomizedLevels/
├── 项目技术文档生成指令.md    # 原始技术研究报告
├── 算法架构部分研究.md        # 算法架构简要
├── 说明文档.md                # 本文档 (5S)
└── docs/
    ├── ALIGNMENT_HybridPCG.md # 对齐文档
    ├── CONSENSUS_HybridPCG.md # 共识文档
    ├── DESIGN_HybridPCG.md    # 设计文档
    └── TASK_HybridPCG.md      # 任务文档
```

---

## 五、验收标准

### 5.1 功能验收
- [ ] 关卡100%可通关（1000次测试）
- [ ] 支持任意连通不规则形状
- [ ] Boss房间正确位于Exit前
- [ ] 难度递进影响敌人数量

### 5.2 性能验收
- [ ] 生成时间 < 100ms
- [ ] 运行帧率 >= 60 FPS
- [ ] 无运行时GC分配

### 5.3 代码验收
- [ ] 0 Error, 0 Warning
- [ ] 函数级注释完整
- [ ] 单元测试覆盖核心算法

---

## 六、风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| WFC死锁 | 迭代上限500次+局部重置 |
| 路径断裂 | 物理验证+补救模块 |
| 性能问题 | SetTilesBlock+Job/Burst |

---

## 七、联系与更新

- **最后更新**: 2026-01-15
- **当前状态**: 6A工作流 - 阶段4 Approve (待审批)
- **下一步**: 用户审批通过后进入开发实施阶段
