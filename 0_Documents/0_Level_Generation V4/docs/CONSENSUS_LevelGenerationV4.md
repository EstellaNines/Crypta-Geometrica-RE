# V4 多房间PCG生成系统 - 共识文档 (CONSENSUS)

> **文档版本**: 1.0  
> **创建日期**: 2026-01-17  
> **状态**: 基于ALIGNMENT确认

---

## 1. 最终需求确认

### 1.1 核心功能需求

| ID | 需求描述 | 优先级 | 来源 |
|----|----------|--------|------|
| FR-01 | 宏观层：基于醉汉游走算法生成NxM网格拓扑 | P0 | 研究文档 |
| FR-02 | 宏观层：BFS算法确保起点到终点连通性 | P0 | 研究文档 |
| FR-03 | 微观层：元胞自动机生成洞穴地形 | P0 | 研究文档 |
| FR-04 | 微观层：柏林噪声生成自然地形 | P1 | 研究文档 |
| FR-05 | 微观层：泊松盘采样放置内容物 | P2 | 研究文档 |
| FR-06 | 渲染层：批量Tilemap渲染 | P0 | 研究文档 |
| FR-07 | 渲染层：时间切片物理碰撞烘焙 | P0 | 研究文档 |
| FR-08 | 配置层：Inspector可视化配置生成流程 | P0 | 研究文档 |

### 1.2 非功能需求

| ID | 需求描述 | 指标 | 优先级 |
|----|----------|------|--------|
| NFR-01 | 异步生成，主线程零阻塞 | 单帧耗时 < 16ms | P0 |
| NFR-02 | 大地图支持 | 1000x1000 无卡顿 | P0 |
| NFR-03 | 种子确定性 | 相同种子 = 相同结果 | P0 |
| NFR-04 | 可扩展性 | 新增算法无需修改核心代码 | P0 |
| NFR-05 | GC优化 | 使用ArrayPool减少内存分配 | P1 |

### 1.3 约束条件

| 约束 | 描述 |
|------|------|
| **技术栈** | Unity 2022+, C#, UniTask, Odin Inspector |
| **依赖** | 不引入额外第三方库 |
| **兼容性** | 需与现有Tilemap系统兼容 |
| **V3处理** | 保留V3代码作为参考，不删除 |

---

## 2. 技术选型确认

### 2.1 核心技术栈

```
┌─────────────────────────────────────────────────────────┐
│                   V4 PCG Generator                       │
├─────────────────────────────────────────────────────────┤
│  Odin Inspector        [SerializeReference] 多态UI      │
│  UniTask v2.5.10       异步计算 + 线程切换              │
│  Unity Tilemap         批量渲染 SetTilesBlock           │
│  CompositeCollider2D   时间切片物理烘焙                 │
└─────────────────────────────────────────────────────────┘
```

### 2.2 架构模式确认

| 模式 | 应用场景 | 确认状态 |
|------|----------|----------|
| **策略模式** | 生成规则可插拔 | ✅ 确认 |
| **黑板模式** | 规则间数据共享 | ✅ 确认 |
| **管线模式** | 规则顺序执行 | ✅ 确认 |
| **SerializeReference** | 多态序列化 | ✅ 确认 |

---

## 3. 验收标准

### 3.1 功能验收

| 验收项 | 验收标准 | 验证方法 |
|--------|----------|----------|
| 拓扑生成 | 生成有效NxM网格，起点终点连通 | 单元测试 + 可视化 |
| 地形填充 | 元胞自动机产出自然洞穴 | 视觉检查 + 连通性测试 |
| 渲染输出 | Tilemap正确显示所有地形 | 视觉检查 |
| 物理碰撞 | 碰撞体与地形吻合 | 玩家移动测试 |
| 配置功能 | Inspector可拖拽配置规则 | 操作演示 |

### 3.2 性能验收

| 验收项 | 目标指标 | 验证方法 |
|--------|----------|----------|
| 帧率稳定 | 生成期间 > 30 FPS | Profiler监控 |
| 内存峰值 | < 500MB (1000x1000地图) | Memory Profiler |
| 生成耗时 | < 3秒 (1000x1000地图) | 计时器 |

### 3.3 质量验收

| 验收项 | 验收标准 |
|--------|----------|
| 代码规范 | 所有公开方法有XML文档注释 |
| 可测试性 | 核心算法有对应单元测试 |
| 可维护性 | 单个文件 < 500行 |

---

## 4. 边界定义

### 4.1 范围内 (In Scope)

- ✅ 宏观拓扑生成（醉汉游走 + 连通性校验）
- ✅ 微观地形生成（元胞自动机 + 噪声）
- ✅ 内容放置（泊松盘采样框架）
- ✅ Tilemap渲染管线
- ✅ 时间切片物理烘焙
- ✅ Inspector配置界面

### 4.2 范围外 (Out of Scope)

- ❌ 敌人AI行为逻辑
- ❌ 关卡存档/加载（使用现有ES3）
- ❌ 多人联机同步
- ❌ 运行时地图编辑
- ❌ 3D地形生成

---

## 5. 风险与缓解措施

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 序列化版本兼容 | 中 | 中 | 添加版本号字段，编写迁移工具 |
| 异步调试困难 | 中 | 低 | 使用UniTask Tracker窗口 |
| 性能不达预期 | 低 | 中 | 预留Burst/Jobs优化接口 |
| 算法效果不理想 | 中 | 中 | 预留参数调优空间，支持热重载 |

---

## 6. 里程碑定义

| 里程碑 | 交付物 | 预计完成 |
|--------|--------|----------|
| **M1: 框架搭建** | Core + 空管线运行 | Day 1 |
| **M2: 宏观层** | 醉汉游走 + BFS | Day 2 |
| **M3: 微观层** | 元胞自动机 | Day 3 |
| **M4: 渲染层** | Tilemap + 物理 | Day 4 |
| **M5: 集成测试** | 完整流程可用 | Day 5 |

---

## 7. 决策记录

| 决策ID | 决策内容 | 决策理由 | 决策日期 |
|--------|----------|----------|----------|
| D-001 | 使用SerializeReference而非继承SO | 减少资产文件数量，配置更集中 | 2026-01-17 |
| D-002 | 保留V3代码作为参考 | 便于对照和回滚 | 2026-01-17 |
| D-003 | 网格尺寸支持可配置NxM | 灵活性更高 | 2026-01-17 |
| D-004 | 每个Rule独立异步 | 便于调试和取消 | 2026-01-17 |

---

**共识确认 - 待用户最终确认后进入设计阶段**
