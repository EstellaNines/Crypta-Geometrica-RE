一、架构概览
该系统采用三层嵌套架构：

层级	参考原型	核心职责	关键技术
宏观层	Spelunky	确定性骨架、关键路径	状态机网格、受限随机游走
中观层	Dead Cells	有机血肉、房间内部	软边界、WFC波函数坍缩
微观层	数学着色	视觉表皮、弹性连接	Voronoi图、SDF Shader


二、分阶段实施路线图
阶段 1：核心数据结构与宏观网格
目标：实现 Spelunky 式关键路径生成

RoomNode 数据结构
GridCoordinates - 宏观网格坐标
RoomType - START/EXIT/LR/DROP/LANDING/SIDE/SHOP
ConnectionMask - 4-bit连通性掩码 (NESW)
ActiveZone - 软边界活跃区域
DifficultyRating / IsCriticalPath
关键路径算法
醉汉行走变体 (Restricted Random Walk)
边界约束 + 防抖动约束
概率权重控制垂直纵深
深渊检测
垂直竖井识别 (连续3+ TYPE_SIDE)
阶段 2：软边界与中观填充
目标：实现 Dead Cells 式有机感

软边界系统
活跃区域 A_ij 随机偏移
缓冲区预留给走廊生长
简化版 WFC
微元状态空间：{空气, 地面, 平台, 刺, 水}
边界约束 + 物理约束传播
熵减坍缩 + 冲突回溯
阶段 3：弹性走廊与微观连接
目标：实现有机走廊形态

Voronoi + A 混合算法*
控制点撒布
Voronoi图边缘作为导航图
A*寻路 + 随机扰动权重
形态学处理
膨胀操作拓宽走廊
元胞自动机平滑
阶段 4：Unity引擎集成
目标：性能优化与视觉实现

Tilemap 批处理
SetTilesBlock 一次性提交
避免循环调用 SetTile
物理优化
CompositeCollider2D 合并碰撞体
消除幽灵碰撞
视觉工程
Rule Tiles 自动化边缘
SDF Shader 程序化纹理
世界坐标 Triplanar 映射
阶段 5：路径验证系统
目标：保证关卡可通关性

*物理感知 A **
平台面作为节点
跳跃抛物线轨迹检测
基于玩家物理参数验证
Job System + Burst
并行化连通性检查
SIMD指令优化
局部修复策略
断点插入补救模块
阶段 6：序列化与对象池
目标：存档与性能管理

种子机制
Unity.Mathematics.Random
仅序列化种子+元数据
对象池管理
装饰物/敌人预加载
Lease/Return 机制

三、技术依赖清单
模块	Unity 技术栈
瓦片地图	Tilemap, SetTilesBlock, Rule Tile
物理碰撞	TilemapCollider2D, CompositeCollider2D
着色器	URP Shader Graph, SDF节点
多线程	C# Job System, Burst Compiler
数学库	Unity.Mathematics

四、建议实施优先级
原型阶段 → 宏观网格 Debug 视图，验证关键路径健壮性
核心攻关 → Burst/Job 物理验证器，防止死图
视觉迭代 → 先用单色块，后介入 Shader Graph