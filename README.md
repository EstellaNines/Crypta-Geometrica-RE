# ğŸ° Level Generation V4 - åµŒå¥—å¼ç¨‹åºåŒ–å…³å¡ç”Ÿæˆç³»ç»Ÿ

<p align="center">
  <img src="https://img.shields.io/badge/Unity-2022.3%20LTS-blue?logo=unity" alt="Unity Version">
  <img src="https://img.shields.io/badge/UniTask-2.5.10+-purple" alt="UniTask">
  <img src="https://img.shields.io/badge/Odin_Inspector-3.0+-orange" alt="Odin">
  <img src="https://img.shields.io/badge/Branch-æ–°ç‰ˆæ¨¡å—åŒ–æˆ¿é—´ç”Ÿæˆå™¨V4-brightgreen" alt="Branch">
</p>

> **æ ¸å¿ƒæ¶æ„**: Nested PCG + Loading Pipeline Pattern  
> **ç‰ˆæœ¬**: V4.2.0+  
> **æ›´æ–°æ—¥æœŸ**: 2026-01-21

ä¸€å¥—**åŸºäºè§„åˆ™çš„ç¨‹åºåŒ–å†…å®¹ç”Ÿæˆ (PCG) ç³»ç»Ÿ**ï¼Œç”¨äº Unity ä¸­åˆ›å»ºå¤šæˆ¿é—´åœ°ç‰¢å¸ƒå±€ä¸è‡ªç„¶æ´ç©´åœ°å½¢ã€‚é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œæ”¯æŒå¼‚æ­¥ç”Ÿæˆå’Œçƒ­æ’æ‹”è§„åˆ™ã€‚

---

## ğŸ“– ç›®å½•

- [æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„)
- [åŒå±‚åµŒå¥—è®¾è®¡](#-åŒå±‚åµŒå¥—è®¾è®¡)
- [æ ¸å¿ƒç®—æ³•](#-æ ¸å¿ƒç®—æ³•)
- [é¡¹ç›®ç»“æ„](#-é¡¹ç›®ç»“æ„)
- [è§„åˆ™æ‰§è¡Œé¡ºåº](#-è§„åˆ™æ‰§è¡Œé¡ºåº)
- [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
- [API å‚è€ƒ](#-api-å‚è€ƒ)
- [æŠ€æœ¯æ–‡æ¡£](#-æŠ€æœ¯æ–‡æ¡£)

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| ğŸ§© **è§„åˆ™ç®¡çº¿** | æ¨¡å—åŒ– `IGeneratorRule` æ¥å£ï¼Œæ”¯æŒå¯æ’æ‹”çš„ç”Ÿæˆè§„åˆ™ |
| ğŸ“‹ **é»‘æ¿æ¨¡å¼** | `Context` ç±»å®ç°è§„åˆ™é—´æ•°æ®å…±äº« |
| âš¡ **å¼‚æ­¥ç”Ÿæˆ** | UniTask é©±åŠ¨çš„å¼‚æ­¥æ‰§è¡Œï¼Œæ”¯æŒå–æ¶ˆæ“ä½œ |
| ğŸ—ºï¸ **å®è§‚-å¾®è§‚æ¶æ„** | åˆ†ç¦»çš„æˆ¿é—´å¸ƒå±€ï¼ˆå®è§‚ï¼‰ä¸åœ°å½¢ç»†èŠ‚ï¼ˆå¾®è§‚ï¼‰å±‚ |
| ğŸ¨ **å¤šä¸»é¢˜æ”¯æŒ** | å¯é…ç½®çš„ç“¦ç‰‡ä¸»é¢˜ï¼ˆè“è‰²ã€çº¢è‰²ã€é»„è‰²ï¼‰ |
| ğŸ”§ **ç¼–è¾‘å™¨é›†æˆ** | Odin Inspector å¯è§†åŒ–é…ç½® |
| ğŸ›¡ï¸ **é˜²å¾¡æ€§ç¼–ç¨‹** | å†…ç½®è‡ªæ£€ã€ç†”æ–­å’Œå›é€€æœºåˆ¶ |

---

## ï¿½ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LevelGenerationV4                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    WorldGeneration      â”‚  â”‚      RoomGeneration         â”‚  â”‚
â”‚  â”‚    (å®è§‚å±‚)              â”‚  â”‚      (å¾®è§‚å±‚)               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ WorldGenerator          â”‚  â”‚ DungeonGenerator            â”‚  â”‚
â”‚  â”‚ WorldContext            â”‚  â”‚ DungeonContext              â”‚  â”‚
â”‚  â”‚ WorldPipelineData       â”‚  â”‚ DungeonPipelineData         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                            â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   Rules (è§„åˆ™å±‚)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ Layout  â”‚â†’â”‚ Terrain â”‚â†’â”‚ Content â”‚â†’â”‚ Render  â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ï¿½ åŒå±‚åµŒå¥—è®¾è®¡

æœ¬ç³»ç»Ÿé‡‡ç”¨**åˆ†å½¢åµŒå¥— (Fractal Nesting)** æ¶æ„ï¼Œå°†ç”Ÿæˆä»»åŠ¡æ‹†è§£ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„åŸŸï¼š

### å®è§‚å±‚ï¼šWorldGenerationï¼ˆä¸–ç•Œç”Ÿæˆå™¨ï¼‰

**ç›®æ ‡**ï¼šåœ¨ 2D åæ ‡ç³»ä¸­è®¡ç®— N ä¸ªæˆ¿é—´çš„åæ ‡é›†åˆ

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| ç”Ÿæˆå™¨ | `WorldGenerator.cs` | ç®¡çº¿æ‰§è¡Œå™¨ |
| ä¸Šä¸‹æ–‡ | `WorldContext.cs` | æˆ¿é—´èŠ‚ç‚¹æ•°æ® |
| é…ç½® | `WorldPipelineData.cs` | è§„åˆ™é…ç½® SO |

**è§„åˆ™åˆ†ç±»**ï¼š
- `Layout/` - æˆ¿é—´å¸ƒå±€ç®—æ³•
- `Generation/` - æˆ¿é—´ç”Ÿæˆè§¦å‘

### å¾®è§‚å±‚ï¼šRoomGenerationï¼ˆæˆ¿é—´ç”Ÿæˆå™¨ï¼‰

**ç›®æ ‡**ï¼šåœ¨å°é—­çŸ©å½¢å†…ç”Ÿæˆæœ‰è¶£çš„ç©æ³•ç©ºé—´

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| ç”Ÿæˆå™¨ | `DungeonGenerator.cs` | ç®¡çº¿æ‰§è¡Œå™¨ |
| ä¸Šä¸‹æ–‡ | `DungeonContext.cs` | ç“¦ç‰‡æ•°æ®é»‘æ¿ |
| é…ç½® | `DungeonPipelineData.cs` | è§„åˆ™é…ç½® SO |

**è§„åˆ™åˆ†ç±»**ï¼š
- `Abstractions/` - æ¥å£ä¸åŸºç±»
- `Macro/` - æˆ¿é—´å†…å¸ƒå±€è§„åˆ™
- `Micro/` - åœ°å½¢ç”Ÿæˆè§„åˆ™
- `Content/` - å†…å®¹å¡«å……è§„åˆ™
- `Rendering/` - Tilemap æ¸²æŸ“è§„åˆ™

---

## ğŸ§® æ ¸å¿ƒç®—æ³•

### 1ï¸âƒ£ ç¨€ç–éšæœºæ”¾ç½® (Sparse Random Placement)

ä¸–ç•Œç”Ÿæˆçš„æ ¸å¿ƒç®—æ³•ï¼Œå¼•å…¥"ç¤¾äº¤è·ç¦»"çº¦æŸç”Ÿæˆéçº¿æ€§åœ°å›¾ã€‚

```csharp
// æ ¸å¿ƒçº¦æŸï¼šå¿…é¡»ä¿ç•™1æ ¼é—´éš™
if (HasNeighbor(coord, distance: 1)) continue;
```

- **æ—¶é—´å¤æ‚åº¦**: O(R Ã— N)
- **ç©ºé—´å¤æ‚åº¦**: O(N)

### 2ï¸âƒ£ çº¦æŸé†‰æ±‰æ¸¸èµ° (Constrained Drunkard Walk)

å¼•å…¥æ–¹å‘åç½®é€‚åº”æ¨ªç‰ˆæ¸¸æˆï¼š

| æ–¹å‘ | æƒé‡ | è®¾è®¡æ„å›¾ |
|------|------|----------|
| â¬‡ï¸ Down | 0.45 | æ¨¡æ‹Ÿé‡åŠ› |
| â†”ï¸ Side | 0.25 | æ¨ªå‘å±•å¼€ |
| â¬†ï¸ Up | 0.05 | é˜²æ­¢æ­»å¾ªç¯ |

### 3ï¸âƒ£ ç»†èƒè‡ªåŠ¨æœº (Cellular Automata)

B45/S4 è§„åˆ™æ¼”åŒ–åœ°å½¢ï¼š

```csharp
// Conway's Game of Life å˜ä½“
if (neighbors >= BirthLimit) â†’ Solid
if (neighbors < DeathLimit) â†’ Empty
```

### 4ï¸âƒ£ æ„ŸçŸ¥å‹ç©ºæ°”æŸ±é‡‡æ · (Air Column Sampling)

å‚ç›´æ‰«æçº¿ç®—æ³•æ™ºèƒ½æ”¾ç½®è·³è·ƒå¹³å°ï¼š

```csharp
// è‡ªä¸‹è€Œä¸Šæ‰«æç©ºæ°”æŸ±
if (airCount >= SafeHeight && airCount % Interval == 0)
    â†’ Place platform
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
LevelGenerationV4/
â”œâ”€â”€ WorldGeneration/              # å®è§‚å±‚ï¼šä¸–ç•Œç”Ÿæˆ
â”‚   â”œâ”€â”€ Core/                     # æ ¸å¿ƒæ¡†æ¶
â”‚   â”‚   â”œâ”€â”€ WorldGenerator.cs     # ä¸–ç•Œç”Ÿæˆå™¨æ‰§è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ WorldContext.cs       # ä¸–ç•Œæ•°æ®ä¸Šä¸‹æ–‡
â”‚   â”‚   â””â”€â”€ WorldPipelineData.cs  # ç®¡çº¿é…ç½® SO
â”‚   â”œâ”€â”€ Rules/                    # ä¸–ç•Œè§„åˆ™
â”‚   â”‚   â”œâ”€â”€ Abstractions/         # æ¥å£ä¸åŸºç±»
â”‚   â”‚   â”œâ”€â”€ Layout/               # å¸ƒå±€ç®—æ³•
â”‚   â”‚   â””â”€â”€ Generation/           # ç”Ÿæˆè§¦å‘
â”‚   â”œâ”€â”€ Data/                     # æ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ docs/                     # æŠ€æœ¯æ–‡æ¡£
â”‚   â””â”€â”€ WorldPipeline.asset       # é¢„é…ç½®ç®¡çº¿
â”‚
â”œâ”€â”€ RoomGeneraton/                # å¾®è§‚å±‚ï¼šæˆ¿é—´ç”Ÿæˆ
â”‚   â”œâ”€â”€ Core/                     # æ ¸å¿ƒæ¡†æ¶
â”‚   â”‚   â”œâ”€â”€ DungeonGenerator.cs   # æˆ¿é—´ç”Ÿæˆå™¨æ‰§è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ DungeonContext.cs     # æˆ¿é—´æ•°æ®ä¸Šä¸‹æ–‡
â”‚   â”‚   â””â”€â”€ DungeonPipelineData.cs# ç®¡çº¿é…ç½® SO
â”‚   â”œâ”€â”€ Rules/                    # æˆ¿é—´è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ Abstractions/         # æ¥å£ä¸åŸºç±»
â”‚   â”‚   â”œâ”€â”€ Macro/                # æˆ¿é—´å¸ƒå±€è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ Micro/                # åœ°å½¢ç”Ÿæˆè§„åˆ™
â”‚   â”‚   â”œâ”€â”€ Content/              # å†…å®¹å¡«å……è§„åˆ™
â”‚   â”‚   â””â”€â”€ Rendering/            # Tilemap æ¸²æŸ“
â”‚   â”œâ”€â”€ Data/                     # æ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ Editor/                   # ç¼–è¾‘å™¨æ‰©å±•
â”‚   â”œâ”€â”€ Utilities/                # å·¥å…·ç±»
â”‚   â”œâ”€â”€ docs/                     # æŠ€æœ¯æ–‡æ¡£
â”‚   â”œâ”€â”€ DungeonPipeline.asset     # é¢„é…ç½®ç®¡çº¿
â”‚   â”œâ”€â”€ TileConfig.asset          # ç“¦ç‰‡é…ç½®
â”‚   â”œâ”€â”€ README.md                 # æˆ¿é—´ç”Ÿæˆå™¨æ–‡æ¡£
â”‚   â”œâ”€â”€ TechnicalDoc.md           # æŠ€æœ¯æ–‡æ¡£
â”‚   â””â”€â”€ APIReference.md           # API å‚è€ƒ
â”‚
â””â”€â”€ docs/                         # ç³»ç»Ÿçº§æ–‡æ¡£
    â””â”€â”€ LevelGenerationV4_TechWhitePaper.md  # æŠ€æœ¯ç™½çš®ä¹¦
```

---

## ğŸ”§ è§„åˆ™æ‰§è¡Œé¡ºåº

### æˆ¿é—´ç”Ÿæˆè§„åˆ™ (RoomGeneration)

| é¡ºåº | è§„åˆ™ | ç±»å‹ | æè¿° |
|------|------|------|------|
| 10 | `ConstrainedLayoutRule` | Macro | é†‰æ±‰æ¸¸èµ°æˆ¿é—´å¸ƒå±€ |
| 20 | `BFSValidationRule` | Macro | è¿é€šæ€§éªŒè¯ |
| 30 | `CellularAutomataRule` | Micro | æ´ç©´åœ°å½¢ç”Ÿæˆ |
| 35 | `EntranceExitRule` | Micro | å…¥å£/å‡ºå£é›•åˆ» |
| 36 | `PathValidationRule` | Micro | 2x2 ç©å®¶è·¯å¾„éªŒè¯ |
| 40 | `PlatformRule` | Micro | ç©ºæ°”æŸ±å¹³å°é‡‡æ · |
| 100 | `RoomRenderRule` | Render | èƒŒæ™¯å±‚ |
| 105 | `WallRenderRule` | Render | å¢™å£è¾¹æ¡† |
| 110 | `GroundRenderRule` | Render | åœ°é¢ç“¦ç‰‡ |
| 120 | `PlatformRenderRule` | Render | å¹³å°ç“¦ç‰‡ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºç®¡çº¿èµ„äº§

```
å³é”® â†’ Create â†’ Dungeon â†’ Pipeline Data
```

### 2. é…ç½®è§„åˆ™

åœ¨ Inspector ä¸­æ·»åŠ è§„åˆ™å¹¶è°ƒæ•´å‚æ•°ã€‚

### 3. åœºæ™¯è®¾ç½®

```csharp
// æ·»åŠ  DungeonGenerator ç»„ä»¶åˆ° GameObject
// åˆ†é… PipelineData å’Œ Tilemaps
```

### 4. ç”Ÿæˆ

```csharp
var generator = GetComponent<DungeonGenerator>();
bool success = await generator.GenerateDungeonAsync(seed);
```

---

## ğŸ“– API å‚è€ƒ

### DungeonGenerator

```csharp
// ç”Ÿæˆåœ°ç‰¢ï¼ˆå¯é€‰ç§å­ï¼‰
public async UniTask<bool> GenerateDungeonAsync(int seed = -1)

// å–æ¶ˆå½“å‰ç”Ÿæˆ
public void CancelGeneration()
```

### DungeonContext

```csharp
// ç“¦ç‰‡è®¿é—®
public int GetTile(TilemapLayer layer, int x, int y)
public void SetTile(TilemapLayer layer, int x, int y, int value)

// æˆ¿é—´æ•°æ®
public List<RoomNode> RoomNodes { get; }
public Vector2Int StartRoom { get; }
public Vector2Int EndRoom { get; }
```

### è‡ªå®šä¹‰è§„åˆ™

```csharp
[Serializable]
public class MyRule : GeneratorRuleBase
{
    public MyRule()
    {
        _ruleName = "MyRule";
        _executionOrder = 50;
    }

    public override async UniTask<bool> ExecuteAsync(
        DungeonContext context, 
        CancellationToken token)
    {
        // ä½ çš„ç”Ÿæˆé€»è¾‘
        return true;
    }
}
```

---

## ï¿½ æŠ€æœ¯æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | æè¿° |
|------|------|------|
| æŠ€æœ¯ç™½çš®ä¹¦ | `docs/LevelGenerationV4_TechWhitePaper.md` | å®Œæ•´ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ |
| æˆ¿é—´ç”Ÿæˆå™¨æ–‡æ¡£ | `RoomGeneraton/README.md` | æˆ¿é—´ç”Ÿæˆå­ç³»ç»Ÿ |
| æŠ€æœ¯è§„æ ¼ | `RoomGeneraton/TechnicalDoc.md` | è¯¦ç»†æŠ€æœ¯è§„æ ¼ |
| API å‚è€ƒ | `RoomGeneraton/APIReference.md` | å®Œæ•´ API æ–‡æ¡£ |

---

## ğŸ“¦ ä¾èµ–

| åŒ… | ç‰ˆæœ¬ | ç”¨é€” |
|---|------|------|
| Unity | 2022.3+ | æ¸¸æˆå¼•æ“ |
| [UniTask](https://github.com/Cysharp/UniTask) | 2.5.10+ | å¼‚æ­¥æ”¯æŒ |
| [Odin Inspector](https://odininspector.com/) | 3.0+ | ç¼–è¾‘å™¨ UI |

---

## ğŸ“„ è®¸å¯è¯

MIT License

---

<p align="center">
  <b>Level Generation V4</b> - åµŒå¥—å¼ç¨‹åºåŒ–å…³å¡ç”Ÿæˆç³»ç»Ÿ<br>
  ä¸ºç¨‹åºåŒ–ç”Ÿæˆçˆ±å¥½è€…æ‰“é€  â¤ï¸
</p>
